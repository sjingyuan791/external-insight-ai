# -*- coding: utf-8 -*-
"""
0_Basic_Info_Input.py тАФ COPYтАСPASTE хоМхЕичЙИ
----------------------------------------
* хдЦщГи JSON уВТх╗ГцнвуБЧуАБцЧецЬмциЩц║ЦчФгценхИЖщбЮя╝Иф╗дхТМ5х╣┤цФ╣хоЪуГ╗ф╕нхИЖщбЮ99я╝ЙуВТ
  уВ│уГ╝уГЙхЖЕуБлчЫ┤хЯЛуВБуАВ
* UXя╝ЪуВ┐уГЦхИЖхЙ▓ / хЕехКЫщА▓цНЧуГРуГ╝ / цЦЗхнЧцХ░уГкуВвуГлуВ┐уВдуГауВлуГйуГ╝шбичд║уАВ
"""
from __future__ import annotations
from pathlib import Path
from typing import Dict, List, TypedDict

import streamlit as st
from config import init_page
from ui_components import show_subtitle, show_back_to_top

# ========================================================================= #
# 0. чФгценхИЖщбЮ (хдзхИЖщбЮ тЖТ ф╕нхИЖщбЮ list[dict(code,name)] )                      #
# ========================================================================= #
industry_major_mid: Dict[str, List[Dict[str, str]]] = {
    "ш╛▓ценя╝МцЮЧцен": [
        {"code": "01", "name": "ш╛▓цен"},
        {"code": "02", "name": "цЮЧцен"},
    ],
    "ц╝Бцен": [
        {"code": "03", "name": "ц╝Бценя╝Иц░┤чФгщдКцоЦценуВТщЩдуБПя╝Й"},
        {"code": "04", "name": "ц░┤чФгщдКцоЦцен"},
    ],
    "щЙ▒ценя╝МцОбчЯ│ценя╝МчаВхИйцОбхПЦцен": [
        {"code": "05", "name": "щЙ▒ценя╝МцОбчЯ│ценя╝МчаВхИйцОбхПЦцен"},
    ],
    "х╗║шинцен": [
        {"code": "06", "name": "ч╖ПхРИх╖еф║Лцен"},
        {"code": "07", "name": "шБ╖хИех╖еф║Лценя╝ИшинхВЩх╖еф║ЛценуВТщЩдуБПя╝Й"},
        {"code": "08", "name": "шинхВЩх╖еф║Лцен"},
    ],
    "шг╜щАацен": [
        {"code": "09", "name": "щгЯцЦЩхУБшг╜щАацен"},
        {"code": "10", "name": "щг▓цЦЩуГ╗уБЯуБ░уБУуГ╗щг╝цЦЩшг╜щАацен"},
        {"code": "11", "name": "ч╣Кч╢нх╖ецен"},
        {"code": "12", "name": "цЬицЭРуГ╗цЬишг╜хУБшг╜щАаценя╝Ихо╢хЕ╖уВТщЩдуБПя╝Й"},
        {"code": "13", "name": "хо╢хЕ╖уГ╗шгЕхВЩхУБшг╜щАацен"},
        {"code": "14", "name": "уГСуГлуГЧуГ╗ч┤ЩуГ╗ч┤ЩхКах╖ехУБшг╜щАацен"},
        {"code": "15", "name": "хН░хИ╖уГ╗хРМщЦвщАгцен"},
        {"code": "16", "name": "хМЦхнжх╖ецен"},
        {"code": "17", "name": "чЯ│ц▓╣шг╜хУБуГ╗чЯ│чВншг╜хУБшг╜щАацен"},
        {"code": "18", "name": "уГЧуГйуВ╣уГБуГГуВпшг╜хУБшг╜щАаценя╝ИхИецО▓уВТщЩдуБПя╝Й"},
        {"code": "19", "name": "уВ┤уГашг╜хУБшг╜щАацен"},
        {"code": "20", "name": "уБкуВБуБЧщЭйуГ╗хРМшг╜хУБуГ╗цпЫчЪошг╜щАацен"},
        {"code": "21", "name": "чкпценуГ╗хЬЯчЯ│шг╜хУБшг╜щАацен"},
        {"code": "22", "name": "щЙДщЛ╝цен"},
        {"code": "23", "name": "щЭЮщЙДщЗСх▒Юшг╜щАацен"},
        {"code": "24", "name": "щЗСх▒Юшг╜хУБшг╜щАацен"},
        {"code": "25", "name": "уБпуВУчФицйЯцв░хЩихЕ╖шг╜щАацен"},
        {"code": "26", "name": "чФЯчФгчФицйЯцв░хЩихЕ╖шг╜щАацен"},
        {"code": "27", "name": "ценхЛЩчФицйЯцв░хЩихЕ╖шг╜щАацен"},
        {"code": "28", "name": "щЫ╗хнРщГихУБуГ╗уГЗуГРуВдуВ╣уГ╗щЫ╗хнРхЫЮш╖пшг╜щАацен"},
        {"code": "29", "name": "щЫ╗ц░ЧцйЯцв░хЩихЕ╖шг╜щАацен"},
        {"code": "30", "name": "цГЕха▒щАЪф┐бцйЯцв░хЩихЕ╖шг╜щАацен"},
        {"code": "31", "name": "ш╝╕щАБчФицйЯцв░хЩихЕ╖шг╜щАацен"},
        {"code": "32", "name": "уБЭуБоф╗ЦуБошг╜щАацен"},
    ],
    "щЫ╗ц░ЧуГ╗уВмуВ╣уГ╗чЖ▒ф╛Ыч╡жуГ╗ц░┤щБУцен": [
        {"code": "33", "name": "щЫ╗ц░Чцен"},
        {"code": "34", "name": "уВмуВ╣цен"},
        {"code": "35", "name": "чЖ▒ф╛Ыч╡жцен"},
        {"code": "36", "name": "ц░┤щБУцен"},
    ],
    "цГЕха▒щАЪф┐бцен": [
        {"code": "37", "name": "щАЪф┐бцен"},
        {"code": "38", "name": "цФ╛щАБцен"},
        {"code": "39", "name": "цГЕха▒уВ╡уГ╝уГУуВ╣цен"},
        {"code": "40", "name": "уВдуГ│уВ┐уГ╝уГНуГГуГИщЩДщЪПуВ╡уГ╝уГУуВ╣цен"},
        {"code": "41", "name": "цШахГПуГ╗щЯ│хг░уГ╗цЦЗхнЧцГЕха▒хИ╢ф╜Ьцен"},
    ],
    "щБЛш╝╕ценя╝МщГ╡ф╛┐цен": [
        {"code": "42", "name": "щЙДщБУцен"},
        {"code": "43", "name": "щБУш╖пцЧЕховщБЛщАБцен"},
        {"code": "44", "name": "щБУш╖пш▓ичЙйщБЛщАБцен"},
        {"code": "45", "name": "ц░┤щБЛцен"},
        {"code": "46", "name": "шИкчй║щБЛш╝╕цен"},
        {"code": "47", "name": "хАЙх║лцен"},
        {"code": "48", "name": "щБЛш╝╕уБлщЩДх╕пуБЩуВЛуВ╡уГ╝уГУуВ╣цен"},
        {"code": "49", "name": "щГ╡ф╛┐ценя╝Иф┐бцЫ╕ф╛┐ф║ЛценуВТхРлуВАя╝Й"},
    ],
    "хН╕хг▓ценя╝Мх░Пхг▓цен": [
        {"code": "50", "name": "хРДчиохХЖхУБхН╕хг▓цен"},
        {"code": "51", "name": "ч╣Кч╢нуГ╗шбгцЬНчнЙхН╕хг▓цен"},
        {"code": "52", "name": "щг▓щгЯцЦЩхУБхН╕хг▓цен"},
        {"code": "53", "name": "х╗║чпЙцЭРцЦЩя╝МщЙ▒чЙйуГ╗щЗСх▒ЮцЭРцЦЩчнЙхН╕хг▓цен"},
        {"code": "54", "name": "цйЯцв░хЩихЕ╖хН╕хг▓цен"},
        {"code": "55", "name": "уБЭуБоф╗ЦуБохН╕хг▓цен"},
        {"code": "56", "name": "хРДчиохХЖхУБх░Пхг▓цен"},
        {"code": "57", "name": "ч╣ФчЙйуГ╗шбгцЬНуГ╗ш║луБохЫЮуВКхУБх░Пхг▓цен"},
        {"code": "58", "name": "щг▓щгЯцЦЩхУБх░Пхг▓цен"},
        {"code": "59", "name": "цйЯцв░хЩихЕ╖х░Пхг▓цен"},
        {"code": "60", "name": "уБЭуБоф╗ЦуБох░Пхг▓цен"},
        {"code": "61", "name": "чДбх║ЧшИЧх░Пхг▓цен"},
    ],
    "щЗСшЮНценя╝Мф┐ЭщЩ║цен": [
        {"code": "62", "name": "щКАшбМцен"},
        {"code": "63", "name": "хНФхРМч╡Дч╣ФщЗСшЮНцен"},
        {"code": "64", "name": "ш▓╕щЗСценя╝МуВпуГмуВ╕уГГуГИуВлуГ╝уГЙценчнЙщЭЮщаРщЗСф┐бчФицйЯщЦв"},
        {"code": "65", "name": "щЗСшЮНхХЖхУБхПЦх╝Хценя╝МхХЖхУБхЕИчЙйхПЦх╝Хцен"},
        {"code": "66", "name": "шгЬхКйчЪДщЗСшЮНценчнЙ"},
        {"code": "67", "name": "ф┐ЭщЩ║ценя╝Иф┐ЭщЩ║хкТф╗Лф╗гчРЖценя╝Мф┐ЭщЩ║уВ╡уГ╝уГУуВ╣ценуВТхРлуВАя╝Й"},
    ],
    "ф╕НхЛХчФгценя╝МчЙйхУБш│Гш▓╕цен": [
        {"code": "68", "name": "ф╕НхЛХчФгхПЦх╝Хцен"},
        {"code": "69", "name": "ф╕НхЛХчФгш│Гш▓╕ценуГ╗чобчРЖцен"},
        {"code": "70", "name": "чЙйхУБш│Гш▓╕цен"},
    ],
    "хнжшбУчаФчй╢я╝Мх░ВщЦАуГ╗цКАшбУуВ╡уГ╝уГУуВ╣цен": [
        {"code": "71", "name": "хнжшбУуГ╗щЦЛчЩ║чаФчй╢цйЯщЦв"},
        {"code": "72", "name": "х░ВщЦАуВ╡уГ╝уГУуВ╣ценя╝Иф╗ЦуБлхИЖщбЮуБХуВМуБкуБДуВВуБоя╝Й"},
        {"code": "73", "name": "х║ГхСКцен"},
        {"code": "74", "name": "цКАшбУуВ╡уГ╝уГУуВ╣ценя╝Иф╗ЦуБлхИЖщбЮуБХуВМуБкуБДуВВуБоя╝Й"},
    ],
    "хо┐ц│Кценя╝Мщг▓щгЯуВ╡уГ╝уГУуВ╣цен": [
        {"code": "75", "name": "хо┐ц│Кцен"},
        {"code": "76", "name": "щг▓щгЯх║Ч"},
        {"code": "77", "name": "цМБуБбх╕░уВКуГ╗щЕНщБФщг▓щгЯуВ╡уГ╝уГУуВ╣цен"},
    ],
    "чФЯц┤╗щЦвщАгуВ╡уГ╝уГУуВ╣ценя╝Мхипце╜цен": [
        {"code": "78", "name": "ц┤Чц┐пуГ╗чРЖхо╣уГ╗ч╛Охо╣уГ╗ц╡┤ха┤цен"},
        {"code": "79", "name": "уБЭуБоф╗ЦуБочФЯц┤╗щЦвщАгуВ╡уГ╝уГУуВ╣цен"},
        {"code": "80", "name": "хипце╜цен"},
    ],
    "цХЩшВ▓я╝Мхнжч┐ТцФпцП┤цен": [
        {"code": "81", "name": "хнжцабцХЩшВ▓"},
        {"code": "82", "name": "уБЭуБоф╗ЦуБоцХЩшВ▓уГ╗хнжч┐ТцФпцП┤цен"},
    ],
    "хМ╗чЩВя╝МчжПчеЙ": [
        {"code": "83", "name": "хМ╗чЩВцен"},
        {"code": "84", "name": "ф┐ЭхБешбЫчФЯ"},
        {"code": "85", "name": "чд╛ф╝Ъф┐ЭщЩ║уГ╗чд╛ф╝ЪчжПчеЙуГ╗ф╗Лшн╖ф║Лцен"},
    ],
    "шдЗхРИуВ╡уГ╝уГУуВ╣ф║Лцен": [
        {"code": "86", "name": "щГ╡ф╛┐х▒А"},
        {"code": "87", "name": "хНФхРМч╡ДхРИя╝Иф╗ЦуБлхИЖщбЮуБХуВМуБкуБДуВВуБоя╝Й"},
    ],
    "уВ╡уГ╝уГУуВ╣ценя╝Иф╗ЦуБлхИЖщбЮуБХуВМуБкуБДуВВуБоя╝Й": [
        {"code": "88", "name": "х╗ГцгДчЙйхЗжчРЖцен"},
        {"code": "89", "name": "шЗкхЛХш╗КцХ┤хВЩцен"},
        {"code": "90", "name": "цйЯцв░чнЙф┐очРЖценя╝ИхИецО▓уВТщЩдуБПя╝Й"},
        {"code": "91", "name": "шБ╖ценч┤╣ф╗ЛуГ╗хК┤хГНшАЕц┤╛щБгцен"},
        {"code": "92", "name": "уБЭуБоф╗ЦуБоф║ЛценуВ╡уГ╝уГУуВ╣цен"},
        {"code": "93", "name": "цФ┐ц▓╗уГ╗ч╡Мц╕ИуГ╗цЦЗхМЦхЫгф╜У"},
        {"code": "94", "name": "хоЧцХЩ"},
        {"code": "95", "name": "уБЭуБоф╗ЦуБоуВ╡уГ╝уГУуВ╣цен"},
    ],
    "хЕмхЛЩя╝Иф╗ЦуБлхИЖщбЮуБХуВМуВЛуВВуБоуВТщЩдуБПя╝Й": [
        {"code": "96", "name": "хдЦхЫ╜хЕмхЛЩ"},
        {"code": "97", "name": "хЫ╜хо╢хЕмхЛЩ"},
        {"code": "98", "name": "хЬ░цЦ╣хЕмхЛЩ"},
    ],
    "хИЖщбЮф╕НшГ╜уБочФгцен": [
        {"code": "99", "name": "хИЖщбЮф╕НшГ╜уБочФгцен"},
    ],
}

# ------------------------------------------------------------------ #
# 1. хЯ║цЬмшинхоЪуГ╗хоЪцХ░
# ------------------------------------------------------------------ #
ROOT       = Path(__file__).resolve().parent
NEXT_PAGE  = "1_External_Analysis.py"   #  цмбуГЪуГ╝уВ╕уБМчДбуБСуВМуБ░чДбшжЦуБХуВМуБ╛уБЩ

# хЕехКЫщБ╕цКЮшВв
CUSTOMERS = ["BtoC (ф╕АшИм)","BtoB (ф╝Бцен)","щлШщ╜вшАЕ","шЛех╣┤х▒д","уВдуГ│уГРуВжуГ│уГЙ"]
PRICES    = ["ф╜Оф╛бца╝х╕п","ф╕нф╛бца╝х╕п","щлШф╛бца╝х╕п"]
CHANNELS  = ["х║ЧшИЧхЮЛ","шикхХПуВ╡уГ╝уГУуВ╣","уВкуГ│уГйуВдуГ│","х║ЧшИЧя╝ЛуВкуГ│уГйуВдуГ│"]
JP_MAP    = str.maketrans("я╝Ря╝Ся╝Тя╝Уя╝Фя╝Хя╝Ця╝Чя╝Шя╝Щя╝Оя╝М", "0123456789..")

# ------------------------------------------------------------------ #
# 2. уГЪуГ╝уВ╕хИЭцЬЯхМЦ & CSS
# ------------------------------------------------------------------ #
init_page(title="AIч╡МхЦ╢ши║цЦн тАУ хЯ║цЬмцГЕха▒хЕехКЫ")

st.markdown(
    """
<style>
.char-count{font-size:.85em;margin-top:-.3rem}
.char-ok{color:#4caf50}.char-warn{color:#f9a825}.char-err{color:#e53935}
.required:after{content:" *";color:#e53935;font-weight:700}
</style>
""",
    unsafe_allow_html=True,
)

# ------------------------------------------------------------------ #
# 3. Session State
# ------------------------------------------------------------------ #
class UI(TypedDict, total=False):
    ценчио_хдзхИЖщбЮ: str
    ценчио_ф╕нхИЖщбЮ: str
    mid_display: str
    хЬ░хЯЯ: str
    ф╕╗уБкхХЖхУБуГ╗уВ╡уГ╝уГУуВ╣: str
    щбзховх▒д: List[str]
    ф╛бца╝х╕п: str
    ш▓йхг▓цЦ╣ц│Х: str

ui: UI = st.session_state.setdefault("user_input", UI())  # type: ignore[arg-type]
errors: Dict[str,str] = st.session_state.setdefault("errors", {})

major_opts = list(industry_major_mid.keys())
ui.setdefault("ценчио_хдзхИЖщбЮ", major_opts[0])
ui.setdefault("ценчио_ф╕нхИЖщбЮ", industry_major_mid[major_opts[0]][0]["code"])
ui.setdefault("mid_display", "уВ│уГ╝уГЙя╝ЛхРНчз░")

# ------------------------------------------------------------------ #
# 4. Utils (validation)
# ------------------------------------------------------------------ #
def char_len(s:str)->int: return len(s)
def validate()->Dict[str,str]:
    e:Dict[str,str]={}
    req=["ценчио_хдзхИЖщбЮ","ценчио_ф╕нхИЖщбЮ","хЬ░хЯЯ",
         "ф╕╗уБкхХЖхУБуГ╗уВ╡уГ╝уГУуВ╣","щбзховх▒д","ф╛бца╝х╕п","ш▓йхг▓цЦ╣ц│Х"]
    for k in req:
        if not ui.get(k): e[k]="х┐ЕщаИхЕехКЫ"
    if isinstance(ui.get("щбзховх▒д"),list) and not ui["щбзховх▒д"]:
        e["щбзховх▒д"]="1 уБдф╗еф╕КщБ╕цКЮ"
    prod=ui.get("ф╕╗уБкхХЖхУБуГ╗уВ╡уГ╝уГУуВ╣","")
    if prod and not (100<=char_len(prod)<=200):
        e["ф╕╗уБкхХЖхУБуГ╗уВ╡уГ╝уГУуВ╣"]="100уАЬ200цЦЗхнЧуБзхЕехКЫ"
    return e

# ------------------------------------------------------------------ #
# 5. UI цППчФ╗
# ------------------------------------------------------------------ #
show_subtitle("ЁЯПв хЯ║цЬмцГЕха▒хЕехКЫ")
REQUIRED=7
progress = sum(bool(ui.get(k)) for k in
               ["ценчио_хдзхИЖщбЮ","ценчио_ф╕нхИЖщбЮ","хЬ░хЯЯ",
                "ф╕╗уБкхХЖхУБуГ╗уВ╡уГ╝уГУуВ╣","щбзховх▒д","ф╛бца╝х╕п","ш▓йхг▓цЦ╣ц│Х"])/REQUIRED
st.progress(progress, text=f"хЕехКЫхоМф║Жх║ж {int(progress*100)}%")

tab_major, tab_biz = st.tabs(["чФгценхИЖщбЮ","ф║ЛценцГЕха▒"])

with tab_major:
    st.markdown("#### чФгценхИЖщбЮ")
    ui["mid_display"]=st.radio("шбичд║х╜вх╝П",["уВ│уГ╝уГЙя╝ЛхРНчз░","уВ│уГ╝уГЙуБоуБ┐"],
                                horizontal=True)
    ui["ценчио_хдзхИЖщбЮ"]=st.selectbox("хдзхИЖщбЮ",major_opts,
                                 index=major_opts.index(ui["ценчио_хдзхИЖщбЮ"]))
    mids=industry_major_mid[ui["ценчио_хдзхИЖщбЮ"]]
    labels=[d["code"] if ui["mid_display"]=="уВ│уГ╝уГЙуБоуБ┐"
            else f"{d['code']} {d['name']}" for d in mids]
    sel=next((i for i,d in enumerate(mids) if d["code"]==ui["ценчио_ф╕нхИЖщбЮ"]),0)
    choice=st.selectbox("ф╕нхИЖщбЮ",labels,index=sel)
    ui["ценчио_ф╕нхИЖщбЮ"]=choice.split()[0]

with tab_biz:
    st.markdown("#### ф║ЛценцГЕха▒")
    ui["хЬ░хЯЯ"]=st.text_input("цЙАхЬихЬ░я╝Их╕ВхМ║чФ║цЭСя╝Й",ui.get("хЬ░хЯЯ",""))
    prod=st.text_area("хХЖхУБуГ╗уВ╡уГ╝уГУуВ╣цжВшжБ (100уАЬ200хнЧ)",
                      ui.get("ф╕╗уБкхХЖхУБуГ╗уВ╡уГ╝уГУуВ╣",""),height=110)
    ui["ф╕╗уБкхХЖхУБуГ╗уВ╡уГ╝уГУуВ╣"]=prod
    length=char_len(prod)
    cls="char-ok" if 100<=length<=200 else ("char-warn" if length else "char-err")
    st.markdown(f"<span class='char-count {cls}'>чП╛хЬи {length} цЦЗхнЧ</span>",
                unsafe_allow_html=True)

    ui["щбзховх▒д"]=st.multiselect("ф╕╗уБкщбзховх▒д",CUSTOMERS,
                                 default=ui.get("щбзховх▒д",[]))
    ui["ф╛бца╝х╕п"]=st.radio("ф╛бца╝х╕п",PRICES,
                           index=PRICES.index(ui.get("ф╛бца╝х╕п",PRICES[1])))
    ui["ш▓йхг▓цЦ╣ц│Х"]=st.radio("ш▓йхг▓цЦ╣ц│Х",CHANNELS,
                           index=CHANNELS.index(ui.get("ш▓йхг▓цЦ╣ц│Х",CHANNELS[0])))

errors.clear(); errors.update(validate())
for f,msg in errors.items():
    st.write(f"<span class='field-error'>{f}: {msg}</span>",unsafe_allow_html=True)

if st.button("ЁЯТ╛ ф┐ЭхнШ",disabled=bool(errors)):
    st.session_state["user_input"]=ui
    st.success("тЬЕ ф┐ЭхнШуБЧуБ╛уБЧуБЯ")
    if (Path(__file__).resolve().parent / NEXT_PAGE).exists():
        st.button("ЁЯСЙ цмбуБ╕щА▓уВА",on_click=lambda: st.switch_page(NEXT_PAGE))
    else:
        st.warning("цмбуГЪуГ╝уВ╕уБМшжЛуБдуБЛуВКуБ╛уБЫуВУ")

show_back_to_top()
